
<h1>亲自配置shadowsocks中继器的实例</h1>

现有一台境外的shadowsoscks服务器【A】：<span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span>   配置端口<span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">7005</span>   加密方式、密码就不说了</div><div>原本采用本地ss客户端直接链接到<span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span>进行科学上网，但最近感觉不好用了</div><div><div style="margin:0px;color:rgb(0, 0, 0);font-family:Helvetica, 'Hiragino Sans GB', 微软雅黑, 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;font-size:1rem;font-style:normal;font-weight:normal;text-align:start;text-indent:0px;"><br class="Apple-interchange-newline">telnet <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span> 7005失败</div><div style="margin:0px;color:rgb(0, 0, 0);font-family:Helvetica, 'Hiragino Sans GB', 微软雅黑, 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;font-size:1rem;font-style:normal;font-weight:normal;text-align:start;text-indent:0px;">ping <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span> 失败，丢包100%</div><div style="margin:0px;color:rgb(0, 0, 0);font-family:Helvetica, 'Hiragino Sans GB', 微软雅黑, 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;font-size:1rem;font-style:normal;font-weight:normal;text-align:start;text-indent:0px;">mtr <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span> 或 traceroute <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span> 或 tracert <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span> 发现中间很多个点响应no reply</div><br></div><div>可以确认，ISP加强了网络封印，甚至检测到频繁连接境外的且数据为加密的，就一刀切，不让连接。</div><div>故导致此SS无法使用</div><div><br></div><div>解决方案：</div><div>通过多次探索国内多处机器对SS服务器的连接情况，发现只要是具有IDC出口的机器，还是可以连接境外SS成功的。而我们日常使用的民用网络，在出口很容易被掐死。</div><div>现已购买一台国内的服务器【B】，外网IP：<span data-wiz-span="data-wiz-span" style="color: rgb(0, 0, 255);">139.19x.xxx.xxx</span>  内网IP：<span data-wiz-span="data-wiz-span" style="color: rgb(0, 147, 0);">10.18x.xxx.xxx</span></div><div><br></div><div>在B服务器上，配置iptable的流量转发，首先需要安装iptables【yum install iptables，安装过的忽略】</div><div>启用ipv4转发，可以通过以下两种方式之一：</div><div>        方式1：<br></div><div>        vi /etc/sysctl.conf<br></div><div>        在末尾添加一行：net.ipv4.ip_forward=1<br></div><div>        方式2：<br></div><div>        root权限下执行命令：echo 1 > /proc/sys/net/ipv4/ip_forward<br></div><div>对TCP/UDP都配置配置iptables转发规则：</div><div>        逐行执行：<br></div><div>        iptables -t nat -A PREROUTING -p tcp --dport <span data-wiz-span="data-wiz-span" style="color: rgb(0, 147, 0);">17005</span> -j DNAT --to-destination <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx:7005</span>   #TCP去程<br></div><div>        iptables -t nat -A PREROUTING -p udp --dport <span data-wiz-span="data-wiz-span" style="color: rgb(0, 147, 0);">17005</span> -j DNAT --to-destination <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx:7005</span>   #UDP去程<br></div><div>        iptables -t nat -A POSTROUTING -p tcp -d <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span> --dport <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">7005</span> -j SNAT --to-source <span data-wiz-span="data-wiz-span" style="color: rgb(0, 147, 0);">10.18x.xxx.xxx</span>  #TCP回程，这里的--to-source必须指定B的内网IP<br></div><div>        iptables -t nat -A POSTROUTING -p udp -d <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">45.32.xxx.xxx</span> --dport <span data-wiz-span="data-wiz-span" style="color: rgb(255, 0, 0);">7005</span> -j SNAT --to-source <span data-wiz-span="data-wiz-span" style="color: rgb(0, 147, 0);">10.18x.xxx.xxx</span>  #UDP回程<span style="color:rgb(0, 0, 0);font-family:Helvetica, 'Hiragino Sans GB', 微软雅黑, 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;font-size:1rem;font-style:normal;font-weight:normal;text-align:start;text-indent:0px;display:inline !important;">，这里的--to-source必须指定B的内网IP</span><br></div><div>        service iptables save  #保存规则</div><div>        service iptables restart  #重启服务即可生效<br></div><div><br></div><div>验证方案：</div><div><br></div><div>    在用户机器的shadowsocks客户端，填写以上新配置的转发机器的参数：<br></div><div>        IP和端口换成转发机【B】的，其它的密码、加密方式等保持不变<br></div><div>    如果连接成功，且可上google等，则转发成功<br></div>

<br>
参考资料：<a href="https://github.com/shadowsocks/shadowsocks/wiki/Setup-a-Shadowsocks-relay" target="_blank">https://github.com/shadowsocks/shadowsocks/wiki/Setup-a-Shadowsocks-relay</a>
